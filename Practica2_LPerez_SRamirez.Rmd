---
title: 'Práctica 2: Limpieza y validación de los datos'
author: "Luis Manuel Pérez Geraldino y Sergi Ramirez Mitjans"
date: "16/5/2019"
output:
  html_document:
    df_print: paged
---

```{r}
# Instalar paquetes de R
RequiredPackages <- c("Hmisc", "dplyr", 'VIM', 'FactoMineR', 'tidyr', 'dplyr', 'magrittr')
for (i in RequiredPackages) { #Installs packages if not yet installed
    if (!require(i)) install.packages(i)
}
```


# 1. Descripción del dataset

El conjunto de datos obtenido recoge los medicamentos con más facturación en el mundo farmacéutico. A la vez también esta incorporado los medicamentos más consumidos en España. Este dataset es variable ya que se tendrán tantos medicamentos como el código demande. Esto es posible ya que el código esta preparado para hacer de buscador y extractor de aquellos medicamentos que se pasen por parámetros. Algunas variables de las que encontramos en el dataset sería el precio, nombre del medicamente, genérico o url del Vademecum.

```{r}
# Creamos los path que posteriormente deberemos de cargar los objetos

path <- 'C:/Users/User/Desktop/vademecum-consolidation-master/'

archivo <- 'result.csv'

# Leemos los datos para guardar
datos <- read.csv2(paste0(path, archivo), sep = ";", header = T, stringsAsFactors = T, dec = ".", encoding = 'UTF-8')

# Cambiamos el nombre de las columnas para que puedan ser leibles
cols <- c("Medicamento", "URL", "Presentacion", "Codigo_Nacional", "Tipo", "Generico", "Laboratorio", "Estado", "Fecha_Alta", "Fecha_Baja", "Aportacion_Beneficiario", "Principio_Activo", "PVP", "Precio_Referencia", "Menor_Precio_Agrupacion_Homogenea", "Agrupacion_Homogenea", "Diasgnostico_Hospitalario", "Tratamiento_Larga_Duracion", "Control_Medico", "Huerfano", "Enfermedad")

colnames(datos) <- cols

# Generamos el archivo metadata
library(Hmisc)
metadata <- contents(datos)
html(metadata)
```

# 2. Integración y selección de datos

```{r}
# Convertimos los valores de la fecha a character
datos[, 'Fecha_Alta'] <- as.character(datos[, 'Fecha_Alta'])
datos[, 'Fecha_Baja'] <- as.character(datos[, 'Fecha_Baja'])

# Separamos el código de la agrupación
codigos <- strsplit(as.character(datos[, 'Agrupacion_Homogenea']), "-")
data = data.frame(codigo = character(), agrupacion = character(), stringsAsFactors=FALSE)

for (i in 1:length(codigos)){
    if(codigos[i][1] == ""){
      data[i, 1] = as.character(codigos[[i]][1])
      data[i, 2] = as.character(codigos[[i]][1])
    } else {
      data[i, 1] = as.character(codigos[[i]][1])
      data[i, 2] = as.character(codigos[[i]][2])
    }
}

datos[, 'Codigo_Agrupacion'] <- data[, 'codigo']

# Realizamos la separación por laboratorio
lab <- strsplit(as.character(datos[, 'Laboratorio']), ",")
data = data.frame(codigo = character(), laboratorio = character(), sociedad =  character(), stringsAsFactors=FALSE)

for (i in 1:length(codigos)){
    if(length(lab[[i]]) == 3){
      valor1 = as.character(lab[[i]][1])
      valor2 = as.character(lab[[i]][2])
      valor3 = as.character(lab[[i]][3])
    } else {
      if (length(lab[[i]]) == 2){
      valor1 = as.character(lab[[i]][1])
      valor2 = as.character(lab[[i]][2])
      valor3 = ""
      } else {
      valor1 = ""
      valor2 = as.character(lab[[i]][2])
      valor3 = ""
      }
    }
    data[i, 1] = valor1
    data[i, 2] = valor2
    data[i, 3] = valor3
}

datos[, 'Codigo_Laboratorio'] <- data[, 'codigo']
```

### Selección de los datos de interés

```{r}
# Separamos los valores numéricos de otros tipos de valores. Para ello vamos a primero mirar cuantos tipos de variables tenemos. 
lista_clase <- sapply(datos, class)
table(lista_clase)

# Vemos que hemos de generar 4 tipos diferentes 

# Generamos diferentes variables
var_factor    <- unname(which(lista_clase == 'factor'))
var_character <- unname(which(lista_clase == 'character'))
var_numeric   <- unname(which(lista_clase %in% c('numeric', 'integer')))
```

# 3. Limpieza de datos

## 3.1. Ceros y elementos vacíos

Primero de todo vamos a mirar donde tenemos NA's y cuantos NA's hay por cada variable.

```{r}
NAs <- data.frame(absoluto = colSums(is.na(datos)))
NAs[, 'porcentaje'] <- round((NAs$absoluto/nrow(datos))*100, 2)
NAs
```

Por lo tanto, nos replanteamos la idea de imputar las variables `Precio_Referencia` y `Menor_Precio_Agrupacion_Homogenea`. Eliminamos la variable `Generico` ya que el 100% corresponde a NA's.

```{r}
# Eliminamos la variable Generico de nuestro conjunto de datos
datos[, 'Generico'] <- NULL
```

Como tenemos en variables numéricas valores NA's deberemos de imputar estos registros para obtener los que realmente se consideren más cercanos. Para ello utilizaremos un método de imputación llamado *MICE*.

```{r}
# https://www.analyticsvidhya.com/blog/2016/03/tutorial-powerful-packages-imputing-missing-values/

# http://rpubs.com/ydmarinb/429757

# https://rpubs.com/medusa/128029

# 1) Primero vamos a ver los patrones
aggr(datos, prop=FALSE, 
     numbers=TRUE, border=NA,
     combine=TRUE)


library(VIM)
library(FactoMineR)
library(tidyr)
library(dplyr)
library(magrittr)
library(mice)

variables <- c(var_numeric)
Datos_imputados <- mice(datos[, names(datos) %in% colnames(datos)[variables]]
, m=5, seed = 2018)

Datos_imputados <- mice(datos[, names(datos) %in% colnames(datos)[variables]])
completeData <- complete(Datos_imputados)

aggr(completeData)
```

## 3.2. Valores extremos


# 4. Análisis de los datos

## 4.1. Selección de grupos de datos a analizar

## 4.2 Comprobación de normalidad y homogeneidad de la varianza

```{r}

```


## 4.3. Pruebas estadísticas

### 4.3.1. ¿Existen diferencias en el precio según el tipo de medicamento? 

```{r}

```


### 4.3.2. ¿El precio del medicamento es influido por el laboratorio que lo genera?

```{r}

```

### 4.3.3. Modelo de predicción del precio

### 4.3.4. Recomendador de medicamentos

### 4.3.5. Aplicación recomendador de medicamentos

# 5. Representación de resultados

# 6. Resolución del problema

# 7. Código

El código del proyecto se encuentra en el repositorio libre de Github. [Enlace](https://github.com/lmgeraldino/vademecum-consolidation).
